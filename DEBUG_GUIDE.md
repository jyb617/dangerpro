# 实时检测调试指南

## 概述

本文档说明如何使用增强的调试功能来诊断实时检测系统的问题。

## 新增的调试功能

### 1. 详细日志输出

系统现在会输出详细的运行日志，包括：

- ✅ **模块初始化**: 模型加载、配置参数
- ✅ **会话创建**: 视频源打开、线程启动
- ✅ **帧捕获**: 捕获统计、错误计数
- ✅ **特征提取**: 输入输出shape、数据类型
- ✅ **异常检测**: 推理结果、异常得分
- ✅ **异常处理**: 详细的错误信息和堆栈跟踪

### 2. 实时统计信息

系统会追踪以下统计数据：

- `frame_count`: 总捕获帧数
- `segment_count`: 处理的segment数量
- `predict_count`: 推理次数
- `error_count`: 错误次数

### 3. 关键检查点

#### 模块加载阶段 (engines.py)

```log
[2025-11-05 14:00:00] [INFO] ============================================================
[2025-11-05 14:00:00] [INFO] 初始化推理引擎模块
[2025-11-05 14:00:00] [INFO] ✅ 配置文件加载成功
[2025-11-05 14:00:01] [INFO] 正在加载检测模型: inferences/models/detection-fp32.onnx
[2025-11-05 14:00:02] [INFO] ✅ 检测模型加载成功
[2025-11-05 14:00:02] [INFO]    - Providers: ['CPUExecutionProvider']
```

**如果看到错误**:
- `❌ 检测模型文件不存在` → 模型文件缺失，需要下载模型
- `❌ 模型加载失败` → 模型文件损坏或格式错误

#### 会话创建阶段 (realtime.py - __init__)

```log
[2025-11-05 14:00:05] [INFO] ============================================================
[2025-11-05 14:00:05] [INFO] 创建实时检测会话: source='0'
[2025-11-05 14:00:05] [INFO] 正在打开视频源: 0
[2025-11-05 14:00:05] [INFO] ✅ 视频源打开成功!
[2025-11-05 14:00:05] [INFO] 视频参数: 分辨率=640x480, 帧率=30fps
[2025-11-05 14:00:05] [INFO] ✅ 所有线程启动成功
```

**如果看到错误**:
- `❌ 无法打开视频源: 0` → 摄像头不可用或权限不足
- 可能原因列表会自动显示

#### 运行阶段 (实时处理)

```log
[2025-11-05 14:00:06] [INFO] 🎬 CaptureThread 开始运行
[2025-11-05 14:00:06] [INFO] 🔧 PrepareThread 开始运行
[2025-11-05 14:00:06] [INFO] 🧠 PredictThread 开始运行

[2025-11-05 14:00:08] [DEBUG] 📹 已捕获 100 帧, 当前segment队列长度: 16
[2025-11-05 14:00:09] [DEBUG] 📦 Segment队列已满 (16帧), 准备进行特征提取 (第1个segment)

[2025-11-05 14:00:09] [DEBUG] 🔍 开始处理 segment (feature_queue长度: 0)
[2025-11-05 14:00:09] [DEBUG]    → 步骤1: segment预处理
[2025-11-05 14:00:09] [DEBUG]    → 步骤2: 特征提取
[2025-11-05 14:00:09] [DEBUG]    特征提取输入shape: (1, 3, 16, 224, 400), dtype: float32
[2025-11-05 14:00:10] [DEBUG]    特征提取输出shape: (2304,)
[2025-11-05 14:00:10] [DEBUG]    → 步骤3: 特征序列准备 (队列长度: 1)
[2025-11-05 14:00:10] [DEBUG]    → 步骤4: 异常检测推理
[2025-11-05 14:00:10] [DEBUG]    异常检测输入shape: (1, 1, 128), dtype: float32
[2025-11-05 14:00:10] [DEBUG]    异常检测输出shape: (1,), 范围: [0.0234, 0.0234]
[2025-11-05 14:00:10] [INFO] ✅ 推理完成 (#1): 当前异常得分 = 0.0234
```

#### 会话释放阶段

```log
[2025-11-05 14:05:00] [INFO] ============================================================
[2025-11-05 14:05:00] [INFO] 正在释放实时检测会话...
[2025-11-05 14:05:01] [INFO] ============================================================
[2025-11-05 14:05:01] [INFO] 会话统计信息:
[2025-11-05 14:05:01] [INFO]   - 总捕获帧数: 9000
[2025-11-05 14:05:01] [INFO]   - 处理segment数: 562
[2025-11-05 14:05:01] [INFO]   - 推理次数: 562
[2025-11-05 14:05:01] [INFO]   - 错误次数: 0
[2025-11-05 14:05:01] [INFO] 会话已释放
```

## 常见错误诊断

### 错误1: 404 Not Found (无法获取视频流)

**症状**: 浏览器显示无法加载视频，Flask返回404

**可能原因**:

1. **摄像头打开失败**
   ```log
   ❌ 无法打开视频源: 0
   可能原因: 1) 摄像头不存在 2) 权限不足 3) 设备被占用 4) 文件路径错误
   ```

   **解决方案**:
   - 运行测试脚本: `python test_camera_debug.py`
   - 如果在容器中，必须在本地机器运行Flask服务端
   - 临时方案: 使用视频文件替代摄像头

2. **模型文件缺失**
   ```log
   ❌ 检测模型文件不存在: inferences/models/detection-fp32.onnx
   ```

   **解决方案**:
   - 从项目Release下载模型文件
   - 放入 `inferences/models/` 目录

3. **会话未成功创建**
   - 检查数据库连接是否正常
   - 查看Flask控制台的完整错误日志

### 错误2: 推理失败

**症状**: 日志显示特征提取或异常检测错误

```log
❌ 特征提取失败: [ONNXRuntimeError]
   输入shape: (1, 3, 16, 224, 400), dtype: float32
```

**可能原因**:
- 模型输入shape不匹配
- 模型文件损坏
- 精度配置错误 (fp32/fp16)

**解决方案**:
- 检查 `inferences/configs/config.toml` 配置
- 重新下载模型文件
- 确认模型与配置匹配

### 错误3: 帧读取失败

**症状**: 日志频繁显示读取帧失败

```log
⚠️ 读取帧失败 (尝试 150)
```

**可能原因**:
- 摄像头断开连接
- 视频文件读取完毕
- 设备驱动问题

**解决方案**:
- 检查摄像头连接
- 如果是视频文件，可能已播放完毕
- 更新摄像头驱动

## 使用测试脚本

运行预检测试:

```bash
python test_camera_debug.py
```

这会测试:
- ✅ 摄像头是否可访问
- ✅ 模型文件是否存在
- ✅ 系统是否准备就绪

## 调整日志级别

### 查看更详细的调试信息

修改 `inferences/realtime.py`:

```python
logging.basicConfig(
    level=logging.DEBUG,  # DEBUG显示所有信息
    format='[%(asctime)s] [%(levelname)s] [%(threadName)s] %(message)s',
    datefmt='%Y-%m-%d %H:%M:%S'
)
```

### 减少日志输出

```python
logging.basicConfig(
    level=logging.INFO,  # INFO只显示重要信息
    format='[%(asctime)s] [%(levelname)s] %(message)s',
    datefmt='%Y-%m-%d %H:%M:%S'
)
```

## 日志输出位置

- **控制台**: Flask启动的终端窗口
- **文件** (可选): 可以配置日志输出到文件

添加文件日志:

```python
import logging

# 同时输出到控制台和文件
logging.basicConfig(
    level=logging.DEBUG,
    format='[%(asctime)s] [%(levelname)s] [%(threadName)s] %(message)s',
    handlers=[
        logging.FileHandler('realtime_debug.log'),
        logging.StreamHandler()
    ]
)
```

## 性能监控

### 查看处理速度

在日志中搜索:
- `已捕获 X 帧` - 了解捕获速度
- `推理完成 (#X)` - 了解推理频率
- `会话统计信息` - 查看整体性能

### 正常的运行指标

- 捕获帧率: 接近视频源帧率 (如30fps)
- Segment生成: 每16帧生成1个
- 推理频率: 取决于 `predict_interval` 配置

## 报告问题

如果需要报告问题，请提供:

1. ✅ 完整的错误日志
2. ✅ `test_camera_debug.py` 的输出
3. ✅ 配置文件内容
4. ✅ 运行环境信息 (本地/容器/服务器)
5. ✅ 会话统计信息

## 总结

调试代码已添加到以下文件:
- ✅ `inferences/realtime.py` - 实时检测会话管理
- ✅ `inferences/engines.py` - 推理引擎
- ✅ `test_camera_debug.py` - 预检测试脚本

运行流程:
1. 运行 `python test_camera_debug.py` 预检
2. 启动Flask服务端，观察日志
3. 创建实时检测会话
4. 根据日志信息诊断问题

祝调试顺利！🎉
